# 性能基准测试报告

## 测试环境

- **系统**: macOS
- **CPU**: Apple Silicon / Intel
- **编译器**: Clang
- **优化级别**: -O3
- **测试日期**: 2026-01-06

## 测试方法

使用 `test_performance` 程序进行基准测试，每个测试运行10次取平均值。

## 性能测试结果

### 1. Add 算子性能

| 输入大小 | 平均时间 (us) | 吞吐量 (elements/us) | 吞吐量 (M ops/s) |
|---------|--------------|---------------------|-----------------|
| 100 | 0.035 | 2,857 | 28.57 |
| 1,000 | 0.079 | 12,658 | 126.58 |
| 10,000 | 2.44 | 4,098 | 40.98 |
| 100,000 | 41.758 | 2,395 | 23.95 |

**分析**：
- ✅ 小规模（<1000）性能优秀，接近内存带宽限制
- ⚠️ 大规模时性能下降，可能是缓存未命中导致

### 2. MatMul 算子性能

| 矩阵大小 | 平均时间 (us) | GFLOPS | 性能评估 |
|---------|--------------|--------|---------|
| 64x64 | 216.61 | 0.024 | ⚠️ 较慢 |
| 128x128 | 1,888.73 | 0.022 | ⚠️ 较慢 |
| 256x256 | 22,762 | 0.015 | ❌ 很慢 |
| 512x512 | 228,402 | 0.002 | ❌ 极慢 |

**分析**：
- ❌ **严重瓶颈**：使用朴素O(n³)实现，无优化
- 512x512矩阵需要228ms，性能极差
- **建议**：立即使用BLAS库优化（预期提升10-100x）

**GFLOPS计算**：
- 64x64: (2 × 64³) / 216.61us = 0.024 GFLOPS
- 512x512: (2 × 512³) / 228402us = 0.002 GFLOPS

### 3. Conv 算子性能

| 配置 (batch, channels, size) | 平均时间 (us) | 平均时间 (ms) | 性能评估 |
|------------------------------|--------------|---------------|---------|
| 1, 1, 32 | 64.4 | 0.064 | ✅ 良好 |
| 1, 3, 64 | 4,269.9 | 4.27 | ⚠️ 较慢 |
| 4, 16, 128 | 276,775 | 276.78 | ❌ 很慢 |

**分析**：
- ✅ 小规模卷积性能可接受
- ⚠️ 中等规模开始变慢
- ❌ 大规模卷积（4x16x128）需要277ms，性能差
- **建议**：使用im2col + GEMM优化（预期提升5-10x）

## 性能分析

### 瓶颈识别（按优先级排序）

#### 🔴 高优先级瓶颈

1. **MatMul算子 - 严重瓶颈**
   - **当前状态**：使用朴素O(n³)实现，无任何优化
   - **性能数据**：512x512矩阵需要228ms，仅0.002 GFLOPS
   - **影响**：严重影响Transformer等模型性能（大量MatMul操作）
   - **建议**：**立即**使用BLAS库（OpenBLAS/Accelerate）优化
   - **预期提升**：10-100x（取决于矩阵大小）

2. **Conv算子 - 中等瓶颈**
   - **当前状态**：使用简化实现，嵌套循环
   - **性能数据**：4x16x128卷积需要277ms
   - **影响**：影响CNN模型性能
   - **建议**：使用im2col + GEMM优化
   - **预期提升**：5-10x

#### 🟡 中优先级优化

3. **Add算子大规模性能下降**
   - **当前状态**：小规模性能优秀，大规模下降
   - **可能原因**：缓存未命中、内存访问模式
   - **建议**：优化内存访问模式，使用SIMD
   - **预期提升**：1.5-2x

4. **内存访问模式**
   - **当前状态**：可能存在缓存不友好的访问模式
   - **建议**：优化数据布局，使用内存对齐
   - **预期提升**：10-20%

## 优化建议

### 短期优化（1-2周）- 基于实际测试结果

1. **MatMul优化 - 🔴 最高优先级**
   - **现状**：512x512需要228ms，性能极差
   - **方案**：集成OpenBLAS或Accelerate框架
   - **预期提升**：10-100x（从0.002 GFLOPS提升到0.2-2 GFLOPS）
   - **工作量**：2-3天
   - **影响**：大幅提升Transformer模型性能

2. **Conv优化 - 🟡 高优先级**
   - **现状**：4x16x128需要277ms
   - **方案**：实现im2col转换 + 使用GEMM
   - **预期提升**：5-10x（从277ms降到27-55ms）
   - **工作量**：3-5天
   - **影响**：显著提升CNN模型性能

3. **内存优化**
   - **现状**：Add算子大规模性能下降
   - **方案**：优化内存对齐、减少分配次数
   - **预期提升**：10-20%
   - **工作量**：2-3天

### 中期优化（1-2月）

1. **SIMD优化**
   - 完善AVX/AVX2实现
   - 优化关键路径
   - 预期提升：2-4x

2. **多线程优化**
   - 并行化大矩阵运算
   - 优化线程池调度
   - 预期提升：2-8x（取决于CPU核心数）

3. **算子融合**
   - 完善融合算子实现
   - 减少中间结果存储
   - 预期提升：10-30%

## 与参考实现对比

| 算子 | InferUnity | ONNX Runtime | 性能比 |
|------|-----------|--------------|--------|
| Add | - | - | - |
| MatMul | - | - | - |
| Conv | - | - | - |

*注：需要实际运行测试后填充数据*

## MatMul优化记录

### 优化前（朴素实现）
- 64x64: 216.61 us
- 128x128: 1,888.73 us
- 256x256: 22,762 us
- 512x512: 228,402 us (0.002 GFLOPS)

### 优化后（Accelerate BLAS）
- 64x64: [运行测试中]
- 128x128: [运行测试中]
- 256x256: [运行测试中]
- 512x512: [运行测试中]
- 1024x1024: [新增测试]

### 优化方案
- 使用macOS Accelerate框架的`cblas_sgemm`函数
- 自动检测并使用BLAS库（如果可用）
- 保留朴素实现作为fallback

## 更新日志

- 2026-01-06: 创建性能基准测试文档
- 2026-01-06: 集成Accelerate框架优化MatMul算子

