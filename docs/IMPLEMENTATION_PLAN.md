# InferUnity 实现计划与排期

## 阶段划分

### Phase 0: 基础架构 (已完成)
- ✅ 类型系统
- ✅ 张量系统
- ✅ 内存管理
- ✅ 计算图IR
- ✅ 算子抽象层
- ✅ ExecutionProvider接口
- ✅ 优化器框架
- ✅ 运行时系统
- ✅ CPU ExecutionProvider

### Phase 1: 核心功能 (已完成 ✅)

#### Task 1.1: ONNX模型解析器 ✅
**优先级**: P0  
**预计时间**: 1周  
**依赖**: Phase 0  
**状态**: 已完成  
**输出**:
- ✅ ONNX模型加载
- ✅ 图构建
- ✅ 基础算子映射
- ✅ 形状推断系统
- ✅ 单元测试

**子任务**:
1. ✅ 集成ONNX protobuf库
2. ✅ 实现ONNX到内部IR的转换
3. ✅ 支持基础算子（Conv, Relu, MatMul等）
4. ✅ 形状推断（参考ONNX Runtime实现）

#### Task 1.2: 基础算子实现 ✅
**优先级**: P0  
**预计时间**: 2周  
**依赖**: Task 1.1  
**状态**: 已完成  
**输出**:
- ✅ CPU算子实现
- ✅ 算子注册
- ✅ 单元测试

**子任务**:
1. ✅ Conv算子（参考NCNN实现）
2. ✅ ReLU/Sigmoid/Tanh激活函数
3. ✅ MatMul/Add/Mul基础运算
4. ✅ MaxPool/AvgPool池化
5. ✅ BatchNormalization
6. ✅ Softmax
7. ✅ Reshape/Concat/Split/Transpose形状操作算子（新增）
8. ✅ Gather/Slice算子（新增）
9. ✅ GELU/SiLU激活函数（新增，Transformer常用）
10. ✅ LayerNormalization/RMSNorm（新增，Transformer常用）
11. ✅ Sub/Div数学运算（新增）

#### Task 1.3: 图优化器实现 ✅
**优先级**: P0  
**预计时间**: 1周  
**依赖**: Task 1.2  
**状态**: 已完成  
**输出**:
- ✅ 常量折叠完整实现
- ✅ 算子融合实现（4种融合模式）
- ✅ 死代码消除完善
- ✅ SIMD优化（AVX/SSE/NEON）
- ✅ 融合算子单元测试

**子任务**:
1. ✅ 常量折叠算法
2. ✅ Conv+BN+ReLU融合
3. ✅ MatMul+Add融合
4. ✅ Conv+ReLU融合（新增）
5. ✅ BN+ReLU融合（新增）
6. ✅ 内存布局优化（完整实现）

#### Task 1.4: 内存管理优化 ✅
**优先级**: P1  
**预计时间**: 1周  
**依赖**: Task 1.2  
**状态**: 已完成  
**输出**:
- ✅ 内存复用机制
- ✅ 内存池优化（参考NCNN）
- ✅ 内存统计（完整实现）

**子任务**:
1. ✅ 张量生命周期分析（参考NCNN的BlobAllocator）
2. ✅ 内存复用算法
3. ✅ 内存池优化（参考NCNN）
4. ✅ 内存碎片整理（框架已实现）

### Phase 2: 性能优化 (进行中)

#### Task 2.1: CPU后端优化
**优先级**: P0  
**预计时间**: 2周  
**依赖**: Phase 1  
**状态**: 大部分完成  
**输出**:
- ✅ SIMD优化（AVX/SSE/NEON）- 已在Task 1.3中完成
- ✅ 多线程并行（已实现ParallelScheduler）
- ✅ 性能基准测试工具（已创建benchmark工具）

**子任务**:
1. ✅ AVX/AVX2优化（x86）- 已在融合算子中实现
2. ✅ NEON优化（ARM）- 已在融合算子中实现
3. ✅ 多线程并行（已实现，参考ONNX Runtime）
4. ⚠️ 性能测试和调优（进行中）

#### Task 2.2: 形状推断系统 ✅
**优先级**: P0  
**预计时间**: 1周  
**依赖**: Task 1.2  
**状态**: 已完成（提前完成，已在Task 1.1中实现）  
**输出**:
- ✅ 静态形状推断（参考ONNX Runtime）
- ✅ 动态形状支持（Shape结构支持动态维度）
- ✅ 形状验证和错误处理

**子任务**:
1. ✅ 形状推断算法（Graph::InferShapes）
2. ✅ 动态维度处理（Shape::is_dynamic）
3. ✅ 形状验证和错误处理

### Phase 3: 硬件后端

#### Task 3.1: CUDA后端
**优先级**: P1  
**预计时间**: 2周  
**依赖**: Phase 2  
**状态**: 框架已完成，算子实现待CUDA SDK环境  
**输出**:
- ✅ CUDA ExecutionProvider框架
- ✅ CUDA设备管理（CUDADevice）
- ✅ CUDA内存分配器接口
- ✅ CUDA流管理接口
- ⚠️ CUDA算子实现（待CUDA SDK环境）

**子任务**:
1. ✅ CUDA设备管理（已完成）
2. ✅ CUDA内存分配器（已完成）
3. ⚠️ CUDA算子实现（Conv, MatMul等，待CUDA SDK环境）
4. ✅ 流管理（已完成）

#### Task 3.2: TensorRT后端
**优先级**: P1 (Jetson平台必需)  
**预计时间**: 2周  
**依赖**: Task 3.1  
**输出**:
- TensorRT ExecutionProvider
- 模型转换
- 性能优化

**子任务**:
1. TensorRT集成
2. ONNX到TensorRT转换
3. INT8量化支持
4. 动态形状支持

#### Task 3.3: Vulkan后端
**优先级**: P2  
**预计时间**: 2周  
**依赖**: Phase 2  
**输出**:
- Vulkan ExecutionProvider
- SPIR-V编译
- 跨平台GPU支持

### Phase 4: 工具链

#### Task 4.1: 模型转换工具 ✅
**优先级**: P1  
**预计时间**: 1周  
**依赖**: Task 1.1  
**状态**: 已完成  
**输出**:
- ✅ 命令行工具
- ✅ 模型格式转换
- ✅ 模型验证

**子任务**:
1. ✅ validate命令 - 验证ONNX模型
2. ✅ convert命令 - 转换模型格式
3. ✅ info命令 - 打印模型信息

#### Task 4.2: 性能分析器 ✅
**优先级**: P1  
**预计时间**: 1周  
**依赖**: Phase 2  
**状态**: 已完成  
**输出**:
- ✅ 逐层性能分析
- ✅ 内存使用分析
- ✅ 报告生成（CSV导出）

**子任务**:
1. ✅ 节点级性能分析
2. ✅ 算子类型统计
3. ✅ CSV格式导出
4. ✅ 多次迭代平均值

#### Task 4.3: 基准测试套件 ✅
**优先级**: P1  
**预计时间**: 1周  
**依赖**: Phase 2  
**状态**: 已完成  
**输出**:
- ✅ 性能基准测试工具（已创建）
- ✅ 标准模型测试（已实现）
- ✅ 性能对比（已实现）
- ✅ 回归测试（已实现）

**子任务**:
1. ✅ 基准测试套件工具（benchmark_suite）
2. ✅ 批量模型测试
3. ✅ 性能对比功能
4. ✅ 回归测试框架

### Phase 5: 高级功能

#### Task 5.1: 量化支持
**优先级**: P2  
**预计时间**: 2周  
**依赖**: Phase 3  
**输出**:
- INT8量化
- 量化感知训练支持
- 精度验证

#### Task 5.2: Python绑定（可选）
**优先级**: P2（可选功能）  
**预计时间**: 1周  
**依赖**: Phase 2  
**状态**: 框架已创建（可选使用）  
**说明**: 这是可选的高级功能，不影响核心C++引擎。如需Python接口可启用BUILD_PYTHON选项。  
**输出**:
- ✅ pybind11绑定（框架已创建，默认关闭）
- ✅ Python API（基础实现）
- ✅ NumPy集成（已实现）
- ⚠️ 完整API覆盖（待完善，按需）

**子任务**:
1. ✅ pybind11集成和CMake配置（默认BUILD_PYTHON=OFF）
2. ✅ 基础API绑定（InferenceSession、Tensor、Shape）
3. ✅ NumPy数组转换
4. ⚠️ 完整API覆盖（按需完善）

#### Task 5.3: 其他后端
**优先级**: P2  
**预计时间**: 按需  
**依赖**: Phase 3  
**输出**:
- Metal后端（macOS）
- SNPE后端（高通）
- ARM NN后端

## 当前阶段: Phase 1 ✅ (已完成) → Phase 2 ✅ (大部分完成) → Phase 4 ✅ (已完成)

### Phase 1 完成总结 ✅
- ✅ **Task 1.1**: ONNX模型解析器（包含形状推断）
- ✅ **Task 1.2**: 基础算子实现（所有基础算子）
- ✅ **Task 1.3**: 图优化器实现（4种融合模式 + SIMD优化）
- ✅ **Task 1.4**: 内存管理优化（生命周期分析 + 内存复用）
- ✅ **Task 2.2**: 形状推断系统（提前完成）

### Phase 2 完成总结 ✅
- ✅ **Task 2.1**: CPU后端优化（SIMD优化、多线程并行、性能基准测试）
- ✅ **Task 2.2**: 形状推断系统（提前完成）

### Phase 4 完成总结 ✅
- ✅ **Task 4.1**: 模型转换工具（validate、convert、info命令）
- ✅ **Task 4.2**: 性能分析器（逐层分析、内存分析、CSV导出）
- ✅ **Task 4.3**: 基准测试套件（批量测试、性能对比、回归测试）

### 下一步任务 (按优先级 - 聚焦核心C++功能)

1. **完善核心功能** (P0) - ✅ 已完成
   - ✅ Graph序列化（已实现）
   - ⚠️ Graph反序列化（部分实现，建议使用ONNX格式）
   - ✅ Graph深拷贝（Clone已实现）
   - ✅ Tensor序列化/反序列化（已实现）
   - ✅ 更多算子实现（Reshape、Concat、Split、Transpose已实现）
   - ✅ 完善图验证逻辑（已实现）
   - ✅ Tensor切片操作（已实现）
   - ✅ 算子属性获取完善（已实现）

2. **CPU后端优化完善** (P0) - ✅ 已完成
   - ✅ CPU优化策略实现（已实现）
   - ✅ 节点编译优化（已实现）
   - ✅ 执行准备优化（已实现）

3. **测试框架** (P0) - ✅ 已完成
   - ✅ 核心功能单元测试（Tensor、Graph、Memory）
   - ✅ 算子单元测试（所有基础算子）
   - ✅ 集成测试（端到端推理）
   - ✅ 测试文档和指南

4. **日志系统框架** (P0) - ✅ 已完成
   - ✅ 日志级别定义（VERBOSE/INFO/WARNING/ERROR/FATAL）
   - ✅ 单例日志器实现
   - ✅ 控制台和文件输出支持
   - ✅ 线程安全的日志输出
   - ✅ 便捷宏定义（LOG_INFO, LOG_ERROR等）
   - ✅ 集成到InferenceSession

5. **核心功能完善** (P0) - ✅ 已完成
   - ✅ LoadModelFromMemory实现（支持从内存加载ONNX模型）
   - ✅ RunAsync异步推理（已实现）
   - ✅ 跨设备拷贝基础框架（通过CPU中转）
   - ✅ Graph反序列化（部分实现，建议使用ONNX格式）
   - ✅ 更多算子实现（Gather、Slice已添加）

6. **CUDA后端框架** (P1) - ✅ 框架已完成
   - ✅ CUDA设备管理（CUDADevice实现）
   - ✅ CUDA执行提供者框架（CUDAExecutionProvider）
   - ✅ CUDA内存管理接口
   - ✅ CUDA流管理接口
   - ⚠️ CUDA算子实现（待CUDA SDK环境）
   - 说明: 框架已创建，需要CUDA SDK环境才能编译和使用

7. **性能优化** (P0) - ✅ 已完成
   - ✅ FusedConvBNReLU kernel优化（预计算BN参数，优化内存访问）
   - ✅ Gather算子支持任意axis（从节点属性获取）
   - ✅ 算子属性获取完善（所有算子都支持从节点属性获取参数）

3. **Task 2.1: CPU后端优化** (P0)
   - 开始时间: 已完成大部分
   - 状态: 大部分完成
   - 待完成: 性能测试和调优
   - 预计完成: 持续优化

4. **Task 5.2: Python绑定** (P2 - 可选)
   - 状态: 框架已创建，默认关闭
   - 说明: 按需启用，不影响核心引擎

## 里程碑

- **M1**: Phase 1完成 - 基础推理功能可用 ✅ (已完成)
  - 完成时间: 提前完成
  - 包含: ONNX解析、基础算子、图优化、内存管理、形状推断
  
- **M2**: Phase 2完成 - CPU优化完成 ✅ (大部分完成)
  - 完成时间: 已基本完成
  - 包含: SIMD优化、多线程并行、性能基准测试工具
  
- **M3**: Phase 3完成 - 多后端支持 (待开始)
  - 预计完成: 10周后
  
- **M4**: Phase 4完成 - 工具链完备 ✅ (已完成)
  - 完成时间: 已提前完成
  - 包含: 模型转换工具、性能分析器、基准测试套件

## 风险与依赖

### 风险
1. ONNX解析复杂度可能超预期
2. 算子实现需要大量测试
3. 性能优化需要反复调优

### 依赖
1. ONNX protobuf库
2. CUDA/TensorRT SDK（Phase 3）
3. 测试数据集

