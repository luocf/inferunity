#!/usr/bin/env python3
"""
optimum-cli的补丁版本
在导入optimum之前添加torch.rms_norm支持
"""

# 在导入任何其他模块之前，先添加rms_norm
import sys
import os

# 添加rms_norm到torch（在导入torch之后）
def patch_torch():
    import torch
    if not hasattr(torch, 'rms_norm'):
        def rms_norm(input, normalized_shape, weight=None, eps=1e-5, *args, **kwargs):
            """简单的RMSNorm实现"""
            variance = input.pow(2).mean(-1, keepdim=True)
            input = input * torch.rsqrt(variance + eps)
            if weight is not None:
                input = input * weight
            return input
        torch.rms_norm = rms_norm

# 导入torch并应用补丁
try:
    import torch
    patch_torch()
except ImportError:
    pass

# 现在导入optimum-cli的主函数
if __name__ == '__main__':
    from optimum.commands.optimum_cli import main
    sys.exit(main())

